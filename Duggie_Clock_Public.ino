/*
 * ============================================================================
 *                          Duggie Desk Clock/Temp v1.0
 *                                A Simple Project
 * ============================================================================
 *
 * Target Hardware: ESP32, 1.9" OLED 128x64
 *
 * Use:
 *   - Time
 *   - Tempiture
 *
 * A simple easy project
 *
 * Authors: Duggie
 * License: Do whatever you want with it
 * ============================================================================
 */

#include <ESP8266WiFi.h>
#include <WiFiUdp.h>
#include <NTPClient.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

/* -------- OLED -------- */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define OLED_ADDRESS 0x3C
#define SDA_PIN 4   // GPIO4 (D2)
#define SCL_PIN 5   // GPIO5 (D1)

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* -------- Boot Logo Bitmap -------- */
#define LOGO_WIDTH  128
#define LOGO_HEIGHT 64

// 'logo black white', 128x64px
const unsigned char epd_bitmap_logo_black_white [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x3f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xfc, 0x00, 0x00, 
	0x00, 0x00, 0x10, 0x00, 0x03, 0xff, 0xf9, 0xff, 0xff, 0xfe, 0x7f, 0x80, 0x00, 0x08, 0x00, 0x00, 
	0x00, 0x00, 0x09, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0x90, 0x00, 0x00, 
	0x00, 0x00, 0x04, 0xff, 0xfe, 0x70, 0x71, 0xff, 0x8f, 0xfe, 0x79, 0xff, 0xff, 0x20, 0x00, 0x00, 
	0x00, 0x00, 0x02, 0x00, 0x1e, 0x70, 0x73, 0xff, 0x1f, 0xf8, 0x79, 0xe0, 0x7c, 0x40, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x00, 0x1e, 0x70, 0x73, 0xc0, 0x1e, 0x00, 0x79, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x38, 0x1e, 0x70, 0x73, 0xcf, 0xde, 0x3e, 0x79, 0xff, 0xc4, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x38, 0x1e, 0x70, 0x73, 0xc3, 0xde, 0x1e, 0x79, 0xff, 0x84, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x38, 0x1e, 0x70, 0x73, 0xc3, 0xde, 0x1e, 0x79, 0xe0, 0x04, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x38, 0x3e, 0x7f, 0xf3, 0xff, 0xdf, 0xfe, 0x79, 0xe0, 0x01, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x3f, 0xfc, 0x7f, 0xf1, 0xff, 0xcf, 0xfe, 0x79, 0xff, 0xf1, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x3f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf9, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x02, 0xf0, 0x00, 0x07, 0xfb, 0xf9, 0xf9, 0x8c, 0x00, 0x00, 0x0e, 0x40, 0x00, 0x00, 
	0x00, 0x00, 0x08, 0x00, 0x7e, 0x00, 0xc3, 0x83, 0x81, 0xfc, 0x07, 0xf0, 0x00, 0x20, 0x00, 0x00, 
	0x00, 0x00, 0x10, 0x00, 0x1f, 0xc0, 0xc3, 0x83, 0x81, 0x8c, 0x1f, 0xe0, 0x01, 0x08, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0x00, 0x00, 0x30, 0xc3, 0xf9, 0xf9, 0x8c, 0x60, 0x00, 0x00, 0x0c, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xc8, 0x00, 0x00, 0x00, 0x00, 0x9e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0xfe, 0x00, 0x01, 0xff, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfd, 0xc7, 0x8e, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x70, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 1040)
const int epd_bitmap_allArray_LEN = 1;
const unsigned char* epd_bitmap_allArray[1] = {
	epd_bitmap_logo_black_white
};


/* -------- Button -------- */
#define BUTTON_PIN 14  // GPIO14 (D5)

/* -------- WiFi -------- */
const char* ssid     = "SSID";      // Enter SSID here
const char* password = "Password";  // Enter Password here

/* -------- Time -------- */
WiFiUDP ntpUDP;
const long utcOffsetInSeconds = -5 * 3600;   // EST
NTPClient timeClient(ntpUDP, "pool.ntp.org", utcOffsetInSeconds, 60000);

/* -------- OpenWeatherMap -------- */
const char* weatherApiKey = "KEY";     // Enter Weather API Key Here
const char* city = "City";       // Enter City here
const char* countryCode = "Country";        // Enter Country Here
 
float outsideTempF = NAN;
unsigned long lastWeatherUpdate = 0;
const unsigned long weatherInterval = 600000; // 10 minutes

/* -------- Button State -------- */
bool showTemp = false;
bool lastButtonState = HIGH;
unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 50;

/* -------- Functions -------- */
void showBootLogo() {
  display.clearDisplay();
  int x = (SCREEN_WIDTH  - LOGO_WIDTH)  / 2;
  int y = (SCREEN_HEIGHT - LOGO_HEIGHT) / 2;

  display.drawBitmap(
    x, y,
    epd_bitmap_logo_black_white,
    LOGO_WIDTH, LOGO_HEIGHT,
    SSD1306_WHITE
  );

  display.display();
  delay(3000);  // show logo for 3 seconds
}

void updateWeather() {
  if (WiFi.status() != WL_CONNECTED) return;

  WiFiClient client;
  HTTPClient http;

  String url = "http://api.openweathermap.org/data/2.5/weather?q=";
  url += city;
  url += ",";
  url += countryCode;
  url += "&appid=";
  url += weatherApiKey;
  url += "&units=imperial";

  http.begin(client, url);
  int httpCode = http.GET();

  if (httpCode == HTTP_CODE_OK) {
    String payload = http.getString();
    StaticJsonDocument<1024> doc;

    if (deserializeJson(doc, payload) == DeserializationError::Ok) {
      outsideTempF = doc["main"]["temp"].as<float>();
    }
  }

  http.end();
}

/* -------- Setup -------- */
void setup() {
  Serial.begin(115200);

  pinMode(BUTTON_PIN, INPUT_PULLUP);
  Wire.begin(SDA_PIN, SCL_PIN);

  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDRESS)) {
    Serial.println("SSD1306 allocation failed");
    while (true);
  }

  // Show boot logo immediately
  showBootLogo();

  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("Connecting WiFi...");
  display.display();

  // Start WiFi (non-blocking)
  WiFi.begin(ssid, password);
  timeClient.begin();
}

/* -------- Loop -------- */
void loop() {
  timeClient.update();

  // -------- WiFi status check --------
  static unsigned long lastWiFiCheck = 0;
  if (WiFi.status() != WL_CONNECTED) {
    if (millis() - lastWiFiCheck > 5000) { // every 5 seconds
      Serial.println("Waiting for WiFi...");
      lastWiFiCheck = millis();
    }
  }

  // -------- Button Handling --------
  bool reading = digitalRead(BUTTON_PIN);

  if (reading != lastButtonState) {
    lastDebounceTime = millis();
  }

  if ((millis() - lastDebounceTime) > debounceDelay) {
    if (reading == LOW) {   // button pressed
      showTemp = !showTemp; // toggle mode
      Serial.print("Mode toggled: ");
      Serial.println(showTemp ? "TEMP" : "CLOCK");

      while (digitalRead(BUTTON_PIN) == LOW) delay(10); // wait for release
    }
  }

  lastButtonState = reading;

  // -------- Display --------
  display.clearDisplay();

  if (!showTemp) {
    // ===== CLOCK MODE =====
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("Duggie CLOCK");

    int hour   = timeClient.getHours();
    int minute = timeClient.getMinutes();
    int second = timeClient.getSeconds();

    String ampm = "AM";
    if (hour >= 12) ampm = "PM";
    if (hour == 0) hour = 12;
    else if (hour > 12) hour -= 12;

    char timeStr[9];
    sprintf(timeStr, "%02d:%02d:%02d", hour, minute, second);

    display.setTextSize(2);
    display.setCursor(0, 20);
    display.println(timeStr);

    display.setTextSize(1);
    display.setCursor(96, 42);
    display.print(ampm);

  } else {
    // ===== TEMP MODE =====
    if ((millis() - lastWeatherUpdate > weatherInterval) || isnan(outsideTempF)) {
      updateWeather();
      lastWeatherUpdate = millis();
    }

    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("OUTSIDE TEMP");

    if (isnan(outsideTempF)) {
      display.setTextSize(2);
      display.setCursor(0, 24);
      display.println("Loading...");
    } else {
      display.setTextSize(3);
      display.setCursor(0, 20);
      display.print(outsideTempF, 1);
      display.print((char)247);
      display.print("F");
    }
  }

  display.display();
  delay(100);
}
